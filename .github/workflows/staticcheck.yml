name: Multi-Language Static Check

on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: 'Target repository (e.g., owner/repo-name)'
        required: true
        type: string
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  static-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3

      - name: Checkout target repo if manual trigger
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repository }}
          token: ${{ secrets.IOS_TOKEN }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck python3-pip openjdk-17-jdk curl unzip

      - name: Install Python linters
        run: |
          sudo apt-get install -y python3-pip python3-setuptools
          python3 -m pip install --upgrade pip
          pip3 install flake8 pylint

      - name: Install Checkstyle (Java)
        run: |
          curl -LJO https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar

      - name: Set up Go (for checkmake)
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install checkmake
        run: |
          go install github.com/mrtazz/checkmake/cmd/checkmake@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: Create report folder
        run: mkdir -p reports

      - name: C Analysis (cppcheck)
        run: |
          cppcheck --enable=all --quiet --output-file=reports/cppcheck.txt . || true

      - name: Python Analysis (flake8 + pylint)
        run: |
          flake8 . > reports/flake8.txt || true
          pylint $(find . -name "*.py") > reports/pylint.txt || true

      - name: Java Analysis (Checkstyle)
        run: |
          find . -name "*.java" > java-files.txt
          if [ -s java-files.txt ]; then
            java -jar checkstyle-10.12.4-all.jar -c /google_checks.xml -f plain -o reports/checkstyle.txt @java-files.txt || true
          else
            echo "No Java files found." > reports/checkstyle.txt
          fi

      - name: Makefile Analysis (checkmake)
        run: |
          find . -name 'Makefile' -exec checkmake {} \; > reports/checkmake.txt || true

      - name: Mustache Analysis
        run: |
          echo "Checking for Mustache templates..."
          count=$(find . -name '*.mustache' | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "No Mustache files found." > reports/mustache.txt
          else
            echo "Found $count Mustache files. No formal linter used. Files are readable." > reports/mustache.txt
            find . -name '*.mustache' -exec cat {} \; > /dev/null || echo "One or more files unreadable." >> reports/mustache.txt
          fi

      # === HTML Report Generation (structured) ===
      - name: Generate Structured HTML Report
        run: |
          python3 ../scripts/generate_html_report1.py

      - name: Upload Report Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staticcheck-reports
          path: reports/
          retention-days: 14
